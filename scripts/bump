#!/usr/bin/env bun

import { $ } from "bun"

const type = process.argv[2]

if (!type || !["patch", "minor", "major"].includes(type)) {
  console.error("Usage: bump <patch|minor|major>")
  process.exit(1)
}

const staged = await $`git diff --cached --name-only`.text()
if (staged.trim()) {
  console.error("There are staged changes. Unstage or commit them first.")
  process.exit(1)
}

const content = await Bun.file("package.json").text()
const match = content.match(/"version":\s*"(\d+)\.(\d+)\.(\d+)"/)

if (!match) {
  console.error("Could not find version in package.json")
  process.exit(1)
}

const [, major, minor, patch] = match.map(Number)

const newVersion =
  type === "major" ? `${major + 1}.0.0`
  : type === "minor" ? `${major}.${minor + 1}.0`
  : `${major}.${minor}.${patch + 1}`

const tag = `v${newVersion}`

const updated = content.replace(/"version":\s*"\d+\.\d+\.\d+"/, `"version": "${newVersion}"`)
await Bun.write("package.json", updated)

await $`git add package.json`
await $`git commit -m ${tag}`
await $`git tag ${tag}`
console.log(tag)

process.stdout.write("Push and deploy? [y/N] ")
for await (const line of console) {
  if (line.toLowerCase() === "y") {
    await $`git push --tags`
    await $`bun run deploy`
  }
  break
}
